<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>SimÃ¼lasyon - KDS</title>

<style>
body { font-family: Arial; background:#f4f5f7; padding:20px; }
.card { background:#fff; padding:20px; border-radius:14px; margin-bottom:20px; }
table { width:100%; border-collapse:collapse; }
th,td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
.dot {
  width:14px; height:14px; border-radius:50%;
  display:inline-block;
}
.red { background:#ef4444; }
.orange { background:#facc15; }
.green { background:#22c55e; }
button {
  padding:12px 20px;
  border:none;
  background:#2563eb;
  color:white;
  font-size:16px;
  border-radius:10px;
  cursor:pointer;
}
</style>
</head>

<body>

<h1>Ä°ÅŸletme Geneli SimÃ¼lasyon</h1>

<div class="card">
  <h3>Topic BazlÄ± Risk Durumu</h3>
  <table id="topicTable">
    <thead>
      <tr>
        <th>Topic</th>
        <th>Åžikayet %</th>
        <th>Risk</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="card">
  <h3>Karar Ã–nerisi</h3>
  <p id="decisionText">HesaplanÄ±yor...</p>
</div>

<div class="card">
  <button onclick="runSimulation()">Ã‡Ã¶zÃ¼m SimÃ¼lasyonunu Ã‡alÄ±ÅŸtÄ±r</button>
  <div id="afterArea" style="margin-top:16px;"></div>
</div>

<script>
let originalData = [];

async function loadEnterprise() {
  const res = await fetch("/simulasyon-isletme");
  const d = await res.json();

  originalData = d.topics;

  const tbody = document.querySelector("#topicTable tbody");
  tbody.innerHTML = "";

  d.topics.forEach(t => {
    tbody.innerHTML += `
      <tr>
        <td>${t.topic_adi}</td>
        <td>%${t.oran}</td>
        <td><span class="dot ${t.color}"></span></td>
      </tr>
    `;
  });

  document.getElementById("decisionText").innerText =
    "ðŸ§  " + d.decision;
}

function runSimulation() {
  const improvementRate = 0.40;

  const after = originalData.map(t => {
    if (t.risk !== "low") {
      return {
        ...t,
        newOran: Number((t.oran * (1 - improvementRate)).toFixed(1))
      };
    }
    return { ...t, newOran: t.oran };
  });

  let html = "<h4>SimÃ¼lasyon SonrasÄ±</h4><ul>";
  after.forEach(a => {
    html += `<li>${a.topic_adi}: %${a.oran} â†’ %${a.newOran}</li>`;
  });
  html += "</ul>";

  document.getElementById("afterArea").innerHTML = html;
}

loadEnterprise();
</script>

</body>
</html>
